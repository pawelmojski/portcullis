{% extends "base.html" %}

{% block title %}User Groups - Jumphost Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people-fill"></i> User Groups</h2>
    <a href="{{ url_for('user_groups.add') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add Group
    </a>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-diagram-3"></i> Group Hierarchy</h5>
            </div>
            <div class="card-body">
                <div id="hierarchy-tree"></div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Parent Group</th>
                        <th>Members</th>
                        <th>Port Forwarding</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in groups %}
                    <tr>
                        <td>{{ group.id }}</td>
                        <td>
                            <strong><i class="bi bi-people"></i> {{ group.name }}</strong>
                        </td>
                        <td>{{ group.description or '-' }}</td>
                        <td>
                            {% if group.parent_group %}
                                <a href="{{ url_for('user_groups.view', group_id=group.parent_group_id) }}">
                                    {{ group.parent_group.name }}
                                </a>
                            {% else %}
                                <span class="badge bg-secondary">Root</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ group.members|length }} users</span>
                        </td>
                        <td>
                            {% if group.port_forwarding_allowed %}
                                <span class="badge bg-success">Allowed</span>
                            {% else %}
                                <span class="badge bg-secondary">Denied</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('user_groups.view', group_id=group.id) }}" 
                               class="btn btn-sm btn-info" title="View">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{{ url_for('user_groups.edit', group_id=group.id) }}" 
                               class="btn btn-sm btn-warning" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form method="POST" action="{{ url_for('user_groups.delete', group_id=group.id) }}" 
                                  style="display: inline;" onsubmit="return confirm('Delete group {{ group.name }}?');">
                                <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mt-2">No user groups found. Create your first group!</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Simple tree visualization
function buildTreeHTML(node, level = 0) {
    const indent = '&nbsp;'.repeat(level * 4);
    const icon = node.children.length > 0 ? 'üìÅ' : 'üìÑ';
    const portForwarding = node.port_forwarding_allowed ? 
        '<span class="badge bg-success ms-2">Port Fwd</span>' : '';
    
    let html = `<div style="margin-left: ${level * 20}px; margin-bottom: 5px;">
        ${icon} <a href="/user-groups/view/${node.id}"><strong>${node.name}</strong></a>
        <span class="badge bg-info">${node.member_count}</span>
        ${portForwarding}
        <small class="text-muted">${node.description || ''}</small>
    </div>`;
    
    for (const child of node.children) {
        html += buildTreeHTML(child, level + 1);
    }
    
    return html;
}

fetch('/user-groups/api/hierarchy')
    .then(res => res.json())
    .then(data => {
        let html = '';
        for (const root of data) {
            html += buildTreeHTML(root);
        }
        document.getElementById('hierarchy-tree').innerHTML = html || '<p class="text-muted">No groups yet</p>';
    })
    .catch(err => {
        document.getElementById('hierarchy-tree').innerHTML = 
            '<p class="text-danger">Error loading hierarchy</p>';
    });
</script>
{% endblock %}
