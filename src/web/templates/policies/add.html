{% extends "base.html" %}

{% block title %}Grant Access - Jumphost Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-shield-check"></i> Grant Access Policy</h2>
    <a href="{{ url_for('policies.index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back
    </a>
</div>

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('policies.add') }}" id="policyForm">
                    <h5 class="mb-3">1. Select User or Group</h5>
                    
                    <div class="mb-3">
                        <label for="grant_type" class="form-label">Grant Type <span class="required">*</span></label>
                        <select class="form-select" id="grant_type" name="grant_type" required onchange="toggleGrantType()">
                            <option value="user">Individual User</option>
                            <option value="group">User Group</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="userField">
                        <label for="user_id" class="form-label">User <span class="required">*</span></label>
                        <select class="form-select" id="user_id" name="user_id" onchange="loadUserIPs()">
                            <option value="">Select a user...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {{ 'selected' if request.args.get('user_id') == user.id|string }}>
                                {{ user.username }} ({{ user.email or 'no email' }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3" id="userGroupField" style="display: none;">
                        <label for="user_group_id" class="form-label">User Group <span class="required">*</span></label>
                        <select class="form-select" id="user_group_id" name="user_group_id">
                            <option value="">Select a group...</option>
                            {% for group in user_groups %}
                            <option value="{{ group.id }}">
                                {{ group.name }} ({{ group.members|length }} members)
                                {% if group.parent_group %} - child of {{ group.parent_group.name }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3" id="sourceIpField">
                        <label for="source_ip_id" class="form-label">Source IP</label>
                        <select class="form-select" id="source_ip_id" name="source_ip_id">
                            <option value="">ANY (all source IPs)</option>
                        </select>
                        <small class="form-text text-muted">Leave as ANY or select specific source IP (only for individual users)</small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">2. Select Server</h5>
                    
                    <div class="mb-3">
                        <label for="scope_type" class="form-label">Server Type <span class="required">*</span></label>
                        <select class="form-select" id="scope_type" name="scope_type" required onchange="toggleScopeFields()">
                            <option value="">Select server type...</option>
                            <option value="group">Server Group (all servers in group)</option>
                            <option value="server">Single Server</option>
                            <option value="service">Single Service (server + protocol)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="groupField" style="display: none;">
                        <label for="target_group_id" class="form-label">Server Group <span class="required">*</span></label>
                        <select class="form-select" id="target_group_id" name="target_group_id">
                            <option value="">Select a group...</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }} ({{ group.members|length }} servers)</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3" id="serverField" style="display: none;">
                        <label for="target_server_id" class="form-label">Server <span class="required">*</span></label>
                        <select class="form-select" id="target_server_id" name="target_server_id">
                            <option value="">Select a server...</option>
                            {% for server in servers %}
                            <option value="{{ server.id }}">{{ server.name }} ({{ server.ip_address }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3" id="protocolField" style="display: none;">
                        <label for="protocol" class="form-label">Protocol <span class="required">*</span></label>
                        <select class="form-select" id="protocol" name="protocol">
                            <option value="">ALL protocols</option>
                            <option value="ssh">SSH only</option>
                            <option value="rdp">RDP only</option>
                        </select>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">3. SSH Configuration (Optional)</h5>
                    
                    <div class="mb-3">
                        <label for="ssh_logins" class="form-label">Allowed SSH Logins</label>
                        <input type="text" class="form-control" id="ssh_logins" name="ssh_logins" 
                               placeholder="root,admin,ubuntu">
                        <small class="form-text text-muted">
                            Comma-separated list of allowed SSH usernames. Leave empty for no restrictions.
                        </small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">4. Additional Permissions</h5>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="port_forwarding_allowed" 
                                   name="port_forwarding_allowed">
                            <label class="form-check-label" for="port_forwarding_allowed">
                                <i class="bi bi-arrow-left-right"></i> Allow SSH Port Forwarding
                            </label>
                            <small class="form-text text-muted d-block">
                                Enable local/remote port forwarding and dynamic SOCKS proxy (ssh -L, -R, -D)
                            </small>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">5. Time Configuration</h5>
                    
                    <div class="mb-3">
                        <label for="start_time" class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-control" id="start_time" name="start_time">
                        <small class="form-text text-muted">Leave empty for immediate access (now). Time is in UTC.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="duration_type" class="form-label">Access Duration / End Time</label>
                        <select class="form-select" id="duration_type" name="duration_type" onchange="toggleDurationFields()">
                            <option value="duration" selected>Duration (relative time)</option>
                            <option value="absolute">Specific Date/Time (absolute)</option>
                        </select>
                        
                        <div id="durationField" class="mt-3">
                            <label for="duration_text" class="form-label">Duration</label>
                            <input type="text" class="form-control" id="duration_text" name="duration_text" 
                                   placeholder="e.g., 2h, 30m, 1d, 1.5h, 2d12h, 1w, 1M, permanent" value="">
                            <small class="form-text text-muted">
                                Examples: <code>30m</code> (30 minutes), <code>2h</code> (2 hours), <code>1.5h</code> (90 minutes), 
                                <code>1d</code> (1 day), <code>2d12h</code> (2 days 12 hours), <code>1w</code> (1 week), 
                                <code>1M</code> or <code>1mo</code> (1 month), <code>1y</code> (1 year).
                                <br>Use <code>0</code> or <code>permanent</code> for permanent access.
                            </small>
                        </div>
                        
                        <div id="absoluteField" class="mt-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="absolute_start_time" class="form-label">Start Date/Time</label>
                                    <input type="datetime-local" class="form-control" id="absolute_start_time" name="absolute_start_time">
                                    <small class="form-text text-muted">Grant becomes active at this time (UTC)</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="end_time" class="form-label">End Date/Time</label>
                                    <input type="datetime-local" class="form-control" id="end_time" name="end_time">
                                    <small class="form-text text-muted">Grant expires at this time (UTC)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">6. Recurring Schedule (Optional)</h5>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="use_schedules" 
                                   name="use_schedules" onchange="toggleScheduleFields()">
                            <label class="form-check-label" for="use_schedules">
                                <i class="bi bi-calendar-week"></i> Enable Recurring Time Windows
                            </label>
                            <small class="form-text text-muted d-block">
                                Restrict access to specific days of week, time ranges, months, or days of month.
                            </small>
                        </div>
                    </div>
                    
                    <div id="scheduleFields" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Multiple schedules work with OR logic:</strong> If any schedule matches current time, access is granted.
                            Use multiple schedules for complex patterns like "Mon-Fri 8-16 OR Sat 2-6".
                        </div>
                        
                        <div id="scheduleList"></div>
                        
                        <div class="card bg-light mt-3">
                            <div class="card-body">
                                <h6>Add New Schedule Rule</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Schedule Name</label>
                                    <input type="text" class="form-control" id="schedule_name" 
                                           placeholder="e.g., Business Hours, Weekend Maintenance">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Days of Week (leave all unchecked for all days)</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="0" id="wd_mon">
                                            <label class="form-check-label" for="wd_mon">Mon</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="1" id="wd_tue">
                                            <label class="form-check-label" for="wd_tue">Tue</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="2" id="wd_wed">
                                            <label class="form-check-label" for="wd_wed">Wed</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="3" id="wd_thu">
                                            <label class="form-check-label" for="wd_thu">Thu</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="4" id="wd_fri">
                                            <label class="form-check-label" for="wd_fri">Fri</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="5" id="wd_sat">
                                            <label class="form-check-label" for="wd_sat">Sat</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="6" id="wd_sun">
                                            <label class="form-check-label" for="wd_sun">Sun</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Time Start (24h)</label>
                                        <input type="time" class="form-control" id="time_start" value="00:00">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Time End (24h)</label>
                                        <input type="time" class="form-control" id="time_end" value="23:59">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Months (leave all unchecked for all months)</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="1" id="m_jan">
                                            <label class="form-check-label" for="m_jan">Jan</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="2" id="m_feb">
                                            <label class="form-check-label" for="m_feb">Feb</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="3" id="m_mar">
                                            <label class="form-check-label" for="m_mar">Mar</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="4" id="m_apr">
                                            <label class="form-check-label" for="m_apr">Apr</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="5" id="m_may">
                                            <label class="form-check-label" for="m_may">May</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="6" id="m_jun">
                                            <label class="form-check-label" for="m_jun">Jun</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="7" id="m_jul">
                                            <label class="form-check-label" for="m_jul">Jul</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="8" id="m_aug">
                                            <label class="form-check-label" for="m_aug">Aug</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="9" id="m_sep">
                                            <label class="form-check-label" for="m_sep">Sep</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="10" id="m_oct">
                                            <label class="form-check-label" for="m_oct">Oct</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="11" id="m_nov">
                                            <label class="form-check-label" for="m_nov">Nov</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="12" id="m_dec">
                                            <label class="form-check-label" for="m_dec">Dec</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Days of Month (optional)</label>
                                    <input type="text" class="form-control" id="days_of_month" 
                                           placeholder="e.g., 1,15 or 1-7 or 1,10,20">
                                    <small class="form-text text-muted">
                                        Comma-separated days (1-31). Leave empty for all days.
                                    </small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Timezone</label>
                                    <select class="form-select" id="timezone">
                                        <option value="Europe/Warsaw" selected>Europe/Warsaw (CET/CEST)</option>
                                        <option value="UTC">UTC</option>
                                        <option value="Europe/London">Europe/London</option>
                                        <option value="America/New_York">America/New_York (EST/EDT)</option>
                                        <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                                        <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                                    </select>
                                </div>
                                
                                <button type="button" class="btn btn-success" onclick="addSchedule()">
                                    <i class="bi bi-plus-circle"></i> Add Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-end gap-2">
                        <a href="{{ url_for('policies.index') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Grant Access
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleGrantType() {
    const grantType = document.getElementById('grant_type').value;
    const userField = document.getElementById('userField');
    const userGroupField = document.getElementById('userGroupField');
    const sourceIpField = document.getElementById('sourceIpField');
    
    if (grantType === 'user') {
        userField.style.display = 'block';
        userGroupField.style.display = 'none';
        sourceIpField.style.display = 'block';
        document.getElementById('user_id').required = true;
        document.getElementById('user_group_id').required = false;
        document.getElementById('user_group_id').value = '';
    } else {
        userField.style.display = 'none';
        userGroupField.style.display = 'block';
        sourceIpField.style.display = 'none';
        document.getElementById('user_id').required = false;
        document.getElementById('user_group_id').required = true;
        document.getElementById('user_id').value = '';
        document.getElementById('source_ip_id').value = '';
    }
}

function toggleScopeFields() {
    const scopeType = document.getElementById('scope_type').value;
    const groupField = document.getElementById('groupField');
    const serverField = document.getElementById('serverField');
    const protocolField = document.getElementById('protocolField');
    
    groupField.style.display = scopeType === 'group' ? 'block' : 'none';
    serverField.style.display = (scopeType === 'server' || scopeType === 'service') ? 'block' : 'none';
    protocolField.style.display = (scopeType === 'service') ? 'block' : 'none';
    
    // Clear fields when hidden
    if (scopeType !== 'group') document.getElementById('target_group_id').value = '';
    if (scopeType !== 'server' && scopeType !== 'service') document.getElementById('target_server_id').value = '';
    if (scopeType !== 'service') document.getElementById('protocol').value = '';
}

function toggleDurationFields() {
    const durationType = document.getElementById('duration_type').value;
    const durationField = document.getElementById('durationField');
    const absoluteField = document.getElementById('absoluteField');
    
    durationField.style.display = durationType === 'duration' ? 'block' : 'none';
    absoluteField.style.display = durationType === 'absolute' ? 'block' : 'none';
}

function loadUserIPs() {
    const userId = document.getElementById('user_id').value;
    const ipSelect = document.getElementById('source_ip_id');
    
    if (!userId) {
        ipSelect.innerHTML = '<option value="">ANY (all source IPs)</option>';
        return;
    }
    
    fetch(`/policies/api/user/${userId}/ips`)
        .then(response => response.json())
        .then(data => {
            ipSelect.innerHTML = '<option value="">ANY (all source IPs)</option>';
            data.ips.forEach(ip => {
                const option = document.createElement('option');
                option.value = ip.id;
                option.textContent = ip.ip + (ip.label ? ` (${ip.label})` : '');
                ipSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading IPs:', error));
}

// Auto-load user IPs if user is pre-selected from URL parameter
document.addEventListener('DOMContentLoaded', function() {
    const userSelect = document.getElementById('user_id');
    if (userSelect && userSelect.value) {
        loadUserIPs();
    }
});

// Schedule management
let schedules = [];

function toggleScheduleFields() {
    const useSchedules = document.getElementById('use_schedules').checked;
    document.getElementById('scheduleFields').style.display = useSchedules ? 'block' : 'none';
}

function parseCommaSeparatedInts(str) {
    if (!str || !str.trim()) return null;
    const parts = str.split(',').map(s => s.trim()).filter(s => s);
    const result = [];
    for (const part of parts) {
        if (part.includes('-')) {
            const [start, end] = part.split('-').map(n => parseInt(n.trim()));
            for (let i = start; i <= end; i++) {
                if (!result.includes(i)) result.push(i);
            }
        } else {
            const num = parseInt(part);
            if (!result.includes(num)) result.push(num);
        }
    }
    return result.length > 0 ? result : null;
}

function addSchedule() {
    const name = document.getElementById('schedule_name').value.trim() || 'Unnamed Schedule';
    
    // Weekdays
    const weekdayChecks = document.querySelectorAll('.weekday-check:checked');
    const weekdays = weekdayChecks.length > 0 ? Array.from(weekdayChecks).map(c => parseInt(c.value)) : null;
    
    // Time
    const timeStart = document.getElementById('time_start').value || '00:00';
    const timeEnd = document.getElementById('time_end').value || '23:59';
    
    // Months
    const monthChecks = document.querySelectorAll('.month-check:checked');
    const months = monthChecks.length > 0 ? Array.from(monthChecks).map(c => parseInt(c.value)) : null;
    
    // Days of month
    const daysOfMonth = parseCommaSeparatedInts(document.getElementById('days_of_month').value);
    
    const timezone = document.getElementById('timezone').value;
    
    const schedule = {
        name: name,
        weekdays: weekdays,
        time_start: timeStart,
        time_end: timeEnd,
        months: months,
        days_of_month: daysOfMonth,
        timezone: timezone
    };
    
    schedules.push(schedule);
    renderSchedules();
    clearScheduleForm();
}

function removeSchedule(index) {
    schedules.splice(index, 1);
    renderSchedules();
}

function clearScheduleForm() {
    document.getElementById('schedule_name').value = '';
    document.querySelectorAll('.weekday-check').forEach(c => c.checked = false);
    document.getElementById('time_start').value = '00:00';
    document.getElementById('time_end').value = '23:59';
    document.querySelectorAll('.month-check').forEach(c => c.checked = false);
    document.getElementById('days_of_month').value = '';
    document.getElementById('timezone').value = 'Europe/Warsaw';
}

function formatScheduleDescription(schedule) {
    const weekdayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    let parts = [];
    
    // Weekdays
    if (schedule.weekdays && schedule.weekdays.length > 0) {
        if (schedule.weekdays.length === 5 && 
            [0,1,2,3,4].every(d => schedule.weekdays.includes(d))) {
            parts.push('Mon-Fri');
        } else if (schedule.weekdays.length === 2 && 
                   schedule.weekdays.includes(5) && schedule.weekdays.includes(6)) {
            parts.push('Weekends only');
        } else {
            const days = schedule.weekdays.map(d => weekdayNames[d]).join('/');
            parts.push(days);
        }
    }
    
    // Time
    if (schedule.time_start !== '00:00' || schedule.time_end !== '23:59') {
        parts.push(`${schedule.time_start}-${schedule.time_end}`);
    }
    
    // Months
    if (schedule.months && schedule.months.length > 0) {
        const months = schedule.months.map(m => monthNames[m-1]).join('/');
        parts.push(months + ' only');
    }
    
    // Days of month
    if (schedule.days_of_month && schedule.days_of_month.length > 0) {
        if (schedule.days_of_month.length === 1 && schedule.days_of_month[0] === 1) {
            parts.push('First day of month');
        } else {
            parts.push('Days: ' + schedule.days_of_month.join(','));
        }
    }
    
    // Timezone
    if (schedule.timezone !== 'Europe/Warsaw') {
        parts.push(`(${schedule.timezone})`);
    }
    
    return parts.length > 0 ? parts.join(' ') : 'All times';
}

function renderSchedules() {
    const container = document.getElementById('scheduleList');
    if (schedules.length === 0) {
        container.innerHTML = '<p class="text-muted">No schedules added yet.</p>';
        return;
    }
    
    let html = '';
    schedules.forEach((schedule, index) => {
        const description = formatScheduleDescription(schedule);
        html += `
            <div class="card mb-2">
                <div class="card-body py-2 d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${schedule.name}</strong>
                        <br>
                        <small class="text-muted">${description}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeSchedule(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// Submit handler to include schedules as JSON
document.getElementById('policyForm').addEventListener('submit', function(e) {
    if (document.getElementById('use_schedules').checked && schedules.length > 0) {
        // Add schedules as JSON to form data
        const schedulesInput = document.createElement('input');
        schedulesInput.type = 'hidden';
        schedulesInput.name = 'schedules_json';
        schedulesInput.value = JSON.stringify(schedules);
        this.appendChild(schedulesInput);
    }
});
</script>
{% endblock %}
